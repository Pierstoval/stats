#!/usr/bin/perl

require "./stats/tag2date.pm";

my %authors;

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}

sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

# P is the percentile
# start is the epoch date of the release
# @a is the array of epoch commit dates
#
# Returns the value in number of months (float)
sub px {
    my ($p, $start, @a) = (@_);
    my @vals = sort {$a <=> $b} @a;
    my $len = @vals;
    my $i = scalar(@vals) * $p/100;
    return ($start - $vals[$i]) / (30 * 24 * 3600);
}

sub singlefile {
    my ($tag, $f) = @_;
    open(G, "git blame -t --line-porcelain $f $tag|");
    my $author;
    my @stamp;
    while(<G>) {
        if(/^committer-time (.*)/) {
            # store every timestamp
            push @stamp, $1;
        }
    }
    close(G);
    return @stamp;
}

sub show {
    my ($tag, $date) = @_;
    my @stamp;
    my $now = `date +%s -d "$date"`;
    my @f=`git ls-tree -r --name-only $tag -- src lib include 2>/dev/null`;

    for my $e (@f) {
        chomp $e;
        if(($e =~ /\.[ch]\z/) || ($e =~ /makefile/i)) {
            push @stamp, singlefile($tag, $e);
        }
    }
    printf "$date;%.2f;%.2f;%.2f;%.2f;%.2f;%.2f;%.2f;%.2f;%.2f;%.2f\n",
        px(10, $now, @stamp),
        px(20, $now, @stamp),
        px(30, $now, @stamp),
        px(40, $now, @stamp),
        px(50, $now, @stamp),
        px(60, $now, @stamp),
        px(70, $now, @stamp),
        px(80, $now, @stamp),
        px(90, $now, @stamp),
        px(95, $now, @stamp);
}

print <<CACHE
2000-03-14;2.51;2.51;2.51;2.51;2.51;2.51;2.51;2.51;2.10;0.93
2000-03-21;2.75;2.75;2.75;2.75;2.75;2.75;2.75;2.75;1.60;0.63
2000-03-21;2.75;2.75;2.75;2.75;2.75;2.75;2.75;2.75;1.17;0.04
2000-08-21;7.84;7.84;7.84;7.84;7.84;7.84;6.03;3.01;3.01;2.04
2000-08-30;8.14;8.14;8.14;8.14;8.14;8.14;5.62;3.31;3.31;1.18
2000-09-28;9.11;9.11;9.11;9.11;9.11;7.96;4.28;4.28;0.44;0.22
2000-10-16;9.71;9.71;9.71;9.71;9.71;7.07;4.88;2.75;0.82;0.45
2000-12-04;11.35;11.35;11.35;11.35;11.35;6.51;6.51;2.45;1.96;0.55
2001-01-05;12.41;12.41;12.41;12.41;10.80;7.58;5.23;3.52;1.61;0.98
2001-01-27;13.15;13.15;13.15;13.15;9.67;8.31;4.25;3.65;0.79;0.62
2001-02-13;13.71;13.71;13.71;13.71;8.88;8.63;4.82;3.15;1.28;0.68
2001-03-22;14.95;14.95;14.95;12.31;9.87;6.05;3.79;1.92;0.90;0.41
2001-04-04;15.38;15.38;15.38;12.74;10.30;6.49;3.98;2.31;1.09;0.74
2001-04-23;16.01;16.01;16.01;13.37;10.61;7.12;4.58;2.91;1.61;1.38
2001-05-07;16.48;16.48;16.48;13.84;10.81;7.35;4.78;3.30;2.08;1.84
2001-06-07;17.51;17.51;17.51;12.68;9.54;8.12;5.08;3.54;2.88;1.38
2001-08-20;19.98;19.98;19.98;15.14;11.09;8.58;6.54;5.50;3.00;0.45
2001-09-25;21.18;21.18;21.18;16.10;11.67;8.35;6.78;4.20;1.09;0.83
2001-11-04;22.51;22.51;21.37;14.08;10.81;8.54;6.38;2.48;1.22;1.05
2001-12-05;23.55;23.55;21.43;14.65;11.19;9.25;6.26;3.25;2.09;0.98
2002-01-23;25.18;25.18;20.35;15.78;12.11;10.48;5.09;3.77;1.71;0.64
2002-02-05;25.61;25.61;20.78;16.12;12.39;10.42;5.35;4.18;1.63;1.08
2002-03-07;26.61;26.61;21.78;16.05;12.64;9.99;6.35;5.15;2.63;2.08
2002-04-15;27.91;27.91;22.83;16.51;13.62;8.38;7.32;5.30;2.94;0.88
2002-05-13;28.84;28.84;23.18;16.48;14.44;9.22;7.55;5.51;2.45;1.13
2002-06-13;29.88;29.88;22.70;17.52;15.38;10.05;8.48;5.35;2.85;1.92
2002-10-01;33.54;33.54;24.65;20.41;16.34;13.20;10.91;7.87;4.40;1.61
2002-10-11;33.88;33.88;24.99;20.40;15.75;13.41;10.60;7.46;4.51;1.38
2002-11-18;35.15;35.15;26.25;21.17;15.71;14.55;11.80;8.12;5.17;2.52
2003-01-14;37.05;37.05;27.79;23.07;17.51;15.75;12.52;9.27;4.42;1.62
2003-04-02;39.64;34.81;27.28;25.01;19.39;17.24;13.03;9.81;4.70;2.75
2003-05-19;41.21;36.38;28.78;26.25;20.92;18.58;14.04;9.32;5.48;3.42
2003-07-28;43.54;35.57;30.07;24.01;22.12;18.98;14.40;8.04;2.94;1.54
2003-08-15;44.14;35.25;30.17;24.35;22.67;17.38;12.25;7.31;2.18;1.00
2003-11-01;46.75;37.49;32.27;26.49;23.28;18.84;12.27;6.14;2.91;1.93
2004-01-22;49.48;39.98;34.80;28.26;24.81;17.95;12.58;6.98;3.54;1.72
2004-03-18;51.35;39.64;31.81;28.94;23.57;15.84;9.39;6.48;1.61;0.08
2004-04-26;52.64;40.28;32.85;29.32;23.65;16.71;10.15;6.15;1.55;1.31
2004-06-02;52.30;39.91;33.53;27.11;20.11;11.91;7.45;2.55;1.22;0.95
2004-08-10;51.34;41.70;34.72;28.33;19.28;12.25;6.68;3.52;2.28;1.55
2004-10-18;53.64;43.84;35.91;28.65;19.10;13.67;7.38;5.71;4.06;3.26
2004-12-20;53.60;43.72;36.71;27.95;18.61;13.06;8.02;7.19;4.39;1.58
2005-02-01;54.05;43.33;37.48;28.71;19.52;13.02;9.36;7.89;3.91;1.73
2005-03-04;54.15;43.25;36.02;26.84;18.73;11.71;9.92;8.11;2.52;0.75
2005-04-05;55.22;44.22;36.40;26.97;19.30;12.51;10.92;8.32;2.74;1.81
2005-05-16;56.22;45.38;37.65;25.51;18.51;12.82;11.54;6.94;3.18;2.10
2005-09-01;59.82;48.82;40.09;27.74;21.01;16.42;14.82;9.71;6.78;4.88
2005-10-13;61.22;50.13;41.11;29.12;21.53;17.82;15.85;10.70;8.17;5.65
2005-12-06;62.88;51.93;42.40;30.31;23.08;19.58;17.65;11.80;8.90;4.87
2006-02-27;64.61;53.75;43.11;33.04;24.71;22.15;20.11;13.48;10.84;5.91
2006-03-20;65.30;54.45;43.81;33.71;25.35;22.85;20.81;14.18;11.54;6.61
2006-06-12;67.12;56.45;44.78;34.23;26.55;24.61;19.24;16.20;5.87;2.17
2006-08-07;68.05;57.85;45.68;36.08;27.75;26.23;20.10;16.21;4.63;3.94
2006-10-29;70.82;59.20;46.34;36.21;30.48;27.53;20.88;12.91;5.13;1.70
2007-01-29;73.81;61.71;47.29;36.74;33.09;27.71;22.80;9.95;4.77;2.90
2007-04-11;75.55;61.62;47.31;37.31;34.52;27.41;20.10;11.18;5.21;1.90
2007-06-25;77.65;63.43;49.18;39.42;36.72;29.20;21.53;11.33;5.38;3.14
2007-07-10;77.67;63.93;49.64;39.65;37.02;29.35;19.38;10.48;4.90;3.04
2007-09-13;79.84;65.88;49.98;41.15;36.55;30.53;17.43;11.19;3.48;1.70
2007-10-29;80.95;66.20;51.03;42.65;37.07;31.14;18.60;9.87;3.67;2.21
2008-01-28;83.90;66.45;52.15;45.22;37.97;29.24;17.21;10.48;4.17;2.68
2008-03-30;85.81;67.82;53.35;47.05;38.88;27.77;18.97;9.71;4.91;3.93
2008-06-04;88.01;70.01;52.88;48.32;40.35;26.27;18.57;10.23;6.70;2.82
2008-09-01;88.41;69.71;54.11;49.97;41.41;26.31;17.71;10.81;5.12;1.07
2008-11-05;88.34;70.28;55.25;49.69;38.78;26.30;16.40;12.08;4.25;2.66
2008-11-13;88.61;70.48;55.48;49.68;38.91;26.57;16.67;12.35;4.15;2.74
2009-01-19;90.49;71.32;57.62;51.28;40.57;28.27;18.54;14.17;5.70;4.18
2009-03-02;91.89;71.07;59.02;51.28;37.13;27.60;18.55;12.67;5.91;2.40
2009-05-18;94.41;72.91;61.59;53.47;37.95;28.48;20.67;13.88;7.34;3.63
2009-08-12;97.08;75.28;64.22;54.81;40.72;30.11;21.52;14.59;7.95;5.18
2009-11-04;99.81;77.95;66.99;57.61;43.44;32.06;24.32;16.02;9.30;5.68
2010-02-09;101.85;79.01;68.72;55.74;40.49;29.74;20.40;12.54;1.93;1.07
2010-04-14;103.82;80.47;70.65;56.14;41.20;30.48;20.73;13.68;4.07;2.74
2010-06-16;104.58;79.87;69.93;51.08;39.52;29.64;20.23;9.52;4.84;1.75
2010-08-11;105.92;81.38;71.19;52.87;40.93;31.26;21.64;8.57;6.56;3.00
2010-10-12;107.33;82.12;72.32;54.84;39.97;31.25;20.77;10.10;6.54;4.84
2010-12-15;108.92;83.02;73.89;56.98;41.77;32.20;22.84;12.23;7.99;5.58
2011-02-17;111.04;84.48;74.80;57.53;43.17;32.90;23.87;14.21;9.34;5.10
2011-04-17;112.58;86.21;75.76;58.13;44.41;32.96;22.70;15.33;10.90;4.50
2011-04-22;112.04;86.38;75.77;57.61;44.34;32.93;22.87;15.18;9.85;4.24
2011-06-23;112.07;87.25;77.48;58.00;44.57;33.54;20.11;16.44;8.77;3.05
2011-09-13;114.80;89.85;78.31;56.17;44.51;31.97;21.30;16.27;6.22;3.64
2011-11-14;111.95;89.95;68.11;51.45;38.58;23.37;19.12;8.35;1.94;1.33
2011-11-17;112.05;90.05;68.21;51.55;38.68;23.47;19.22;8.45;2.04;1.43
2012-01-24;113.40;92.32;69.94;52.68;39.58;25.73;20.70;9.81;4.17;3.70
2012-03-22;115.11;94.08;70.93;54.08;41.28;27.67;22.64;11.20;5.98;5.63
2012-05-24;114.11;94.52;71.67;55.38;42.00;29.77;24.47;13.09;7.73;7.17
2012-07-27;113.15;93.88;71.10;54.47;40.41;30.58;19.64;10.67;7.30;1.75
2012-10-10;115.64;96.05;73.56;55.79;40.99;32.93;21.37;12.93;8.10;4.01
2012-11-20;115.92;97.24;74.24;56.92;42.14;33.67;21.71;14.21;9.00;5.37
2013-02-06;117.61;97.67;72.00;55.58;39.20;33.34;21.69;16.33;7.97;2.97
2013-04-12;118.41;99.45;71.41;56.90;40.53;33.88;19.89;18.44;9.27;3.10
2013-06-22;120.09;101.81;72.73;58.43;42.90;34.71;22.13;18.82;8.07;4.27
2013-08-11;119.83;102.50;73.48;58.18;43.57;32.31;23.01;16.11;7.13;3.95
2013-10-13;120.78;103.68;74.74;57.36;45.34;31.65;24.67;16.35;7.85;2.97
2013-12-16;121.95;102.61;76.61;59.40;47.30;32.87;26.77;18.38;9.21;4.98
2014-01-29;123.24;102.89;77.47;60.87;47.94;33.83;28.23;19.60;9.68;5.57
2014-03-26;124.40;104.21;78.55;61.75;47.89;35.46;30.10;19.54;8.44;4.99
2014-05-20;125.97;104.08;79.58;62.15;49.11;37.25;31.88;18.57;10.27;5.61
2014-07-16;127.34;104.43;81.48;63.27;50.83;37.94;33.27;19.52;11.94;6.86
2014-09-10;128.14;103.19;83.25;64.10;52.70;36.97;31.44;20.37;12.28;6.64
2014-11-05;129.95;105.00;83.20;64.86;54.17;38.83;31.60;21.23;12.45;7.08
2015-01-07;131.58;106.44;81.67;61.70;51.59;40.01;31.29;20.65;9.57;2.21
2015-02-25;133.05;108.08;83.30;63.33;52.32;41.64;32.69;20.41;8.95;2.88
2015-04-22;134.81;109.42;85.17;65.20;52.94;43.20;34.30;21.51;8.35;4.43
2015-04-28;135.01;109.62;85.37;65.40;53.14;43.40;34.50;21.71;8.55;4.61
2015-06-17;136.52;110.33;86.37;67.07;54.03;45.03;34.40;23.14;7.67;5.01
2015-08-11;138.35;111.71;87.47;68.90;55.47;46.87;35.45;24.28;9.28;6.74
2015-10-07;140.01;112.71;89.11;70.23;55.78;48.77;35.47;25.92;11.04;8.16
2015-12-01;141.28;114.29;89.44;71.63;56.71;50.60;35.57;25.97;12.17;8.51
2016-01-27;143.09;115.67;91.16;73.53;58.61;52.50;37.17;27.40;13.93;9.84
2016-02-08;143.49;115.65;91.56;73.93;58.50;52.88;37.57;27.15;14.05;9.32
2016-03-23;144.96;116.44;92.83;75.40;59.91;53.95;38.67;27.47;15.04;10.32
2016-05-17;146.79;117.44;93.67;76.88;61.28;51.71;38.71;25.78;12.48;2.30
2016-05-30;147.22;117.87;93.97;77.30;61.59;51.90;39.10;26.16;12.77;2.55
2016-07-21;148.95;119.60;94.70;78.68;60.35;52.40;39.97;24.92;13.07;3.91
2016-08-03;149.39;119.80;95.13;79.12;60.77;52.83;40.37;25.35;13.50;4.35
2016-09-07;150.55;120.42;95.86;79.71;61.36;53.64;41.34;25.16;12.05;5.51
2016-09-14;150.79;120.63;96.08;79.93;61.59;53.82;41.54;25.20;12.04;5.74
2016-11-02;152.42;121.73;97.48;79.94;63.10;54.00;41.29;25.01;12.62;7.31
2016-12-20;153.79;119.95;96.13;80.44;64.00;54.80;41.65;24.80;8.98;6.02
2016-12-22;153.85;120.02;96.20;80.50;64.07;54.87;41.72;24.87;9.05;6.09
2017-02-22;155.89;121.94;98.20;82.57;66.08;56.72;42.98;26.61;11.12;5.91
2017-02-24;155.95;122.01;98.27;82.64;66.14;56.78;43.05;26.57;11.18;5.98
2017-04-19;157.51;122.82;100.04;84.43;67.78;56.80;43.77;27.31;12.82;4.83
2017-06-14;159.32;124.34;100.83;85.90;69.44;55.92;43.13;27.67;13.34;6.70
2017-08-09;161.05;126.01;100.60;85.60;71.17;56.14;42.91;28.62;13.75;7.13
2017-08-13;161.19;126.02;100.64;85.70;71.30;56.27;43.04;28.74;13.89;7.05
2017-10-04;162.10;124.50;99.50;82.13;71.57;55.47;35.86;20.22;8.81;1.37
2017-10-23;162.73;124.43;99.05;82.27;71.95;55.27;36.45;20.00;8.21;1.85
2017-11-29;163.29;124.13;96.93;80.26;68.31;53.24;35.95;20.38;5.97;2.81
2018-01-23;163.52;124.39;98.20;78.98;68.36;53.88;36.12;19.32;4.91;2.48
2018-03-13;164.35;126.02;99.74;79.64;69.70;54.10;36.27;18.71;6.38;4.07
2018-05-15;166.39;128.02;101.50;81.73;71.24;54.18;36.42;18.22;8.37;5.47
2018-07-11;167.52;129.36;103.40;83.63;72.05;54.40;37.28;19.77;10.05;7.37
2018-09-04;169.35;129.90;104.96;85.24;73.10;55.81;36.88;21.60;10.45;9.21
2018-10-30;169.75;129.25;105.97;86.43;70.67;51.30;31.65;18.20;11.08;5.37
2018-12-12;171.19;130.69;107.31;87.84;71.32;50.65;33.05;19.28;12.51;5.10
2019-02-06;172.88;132.12;108.88;89.57;72.88;52.10;34.92;20.04;14.38;5.09
2019-03-27;173.64;133.00;108.24;91.00;73.61;52.57;36.34;19.18;12.91;6.49
2019-05-22;175.58;134.87;110.05;92.87;75.30;54.30;37.42;20.87;13.22;6.88
2019-06-04;175.87;135.03;110.48;93.30;75.50;54.67;37.34;21.31;13.43;6.99
2019-07-17;177.20;136.24;111.78;94.73;76.37;56.01;38.09;22.74;13.94;7.85
2019-07-19;177.27;136.24;111.80;94.80;76.30;56.07;38.13;22.81;13.87;7.92
2019-09-10;177.51;135.23;113.47;94.67;74.91;54.52;33.97;22.27;11.75;3.92
2019-11-05;179.38;136.71;115.03;95.87;76.26;55.24;35.82;24.13;12.29;3.62
2020-01-08;181.51;138.05;115.54;95.84;77.12;54.32;34.51;25.58;11.04;5.32
2020-03-04;183.38;137.84;112.70;94.31;74.17;49.62;33.10;25.24;9.67;5.12
2020-03-11;183.61;138.07;112.87;94.39;74.40;49.86;33.19;25.15;9.56;5.09
2020-04-29;185.20;137.03;111.31;95.81;74.95;49.85;32.48;23.75;9.10;3.67
2020-06-23;185.18;138.77;111.73;95.83;70.75;51.49;34.04;21.78;9.10;3.57
2020-06-30;185.41;139.00;111.97;96.07;70.66;51.68;34.27;22.01;9.22;3.57
2020-08-19;187.08;140.67;113.58;97.40;71.21;52.99;35.75;23.68;9.48;5.08
2020-10-14;184.80;138.30;111.87;94.57;71.47;49.98;35.60;21.72;9.17;5.07
2020-12-09;186.01;140.17;113.07;96.37;73.04;49.18;37.32;21.72;9.87;6.42
2021-02-03;184.20;138.24;114.14;94.97;70.60;45.71;34.05;18.03;7.99;1.55
2021-03-31;184.96;138.03;115.96;93.95;70.20;45.45;33.64;18.92;7.12;2.40
2021-04-14;185.43;138.50;116.37;94.31;70.44;45.46;33.57;19.08;7.44;2.87
2021-05-26;184.80;139.40;117.68;95.71;65.50;45.37;33.01;16.74;6.73;4.21
2021-07-21;186.67;141.27;119.37;96.38;64.78;47.14;33.97;18.51;7.15;5.38
2021-09-14;187.93;143.10;121.10;97.70;66.61;48.79;34.25;19.17;8.88;6.67
2021-09-22;188.20;143.37;121.37;97.97;66.88;49.05;34.52;19.43;9.14;6.51
2021-11-10;189.83;145.00;122.97;98.80;68.52;49.11;33.76;20.42;9.87;6.72
2022-01-05;191.70;146.87;124.83;98.67;70.34;50.53;34.62;21.02;11.69;7.45
2022-03-05;193.58;147.51;124.75;96.33;70.09;52.50;33.00;21.95;12.95;6.89
2022-04-27;195.05;149.28;124.37;94.87;68.91;53.57;33.67;21.71;12.35;6.87
2022-05-11;195.30;149.74;124.77;95.18;69.11;54.04;34.13;21.54;12.82;7.15
2022-06-27;195.90;151.16;124.88;93.77;68.00;55.47;34.90;21.43;13.51;5.69
2022-08-31;196.71;152.27;124.48;94.81;70.04;55.57;35.75;22.18;13.97;6.68
2022-10-26;197.78;151.81;125.78;95.91;67.70;53.08;33.91;21.95;11.35;4.68
2022-12-21;197.74;153.50;121.17;95.70;64.51;48.92;32.22;22.32;6.75;1.78
2023-02-15;194.87;151.88;121.30;88.34;64.07;43.51;27.78;16.67;3.18;1.54
2023-02-20;195.03;152.05;121.43;88.51;64.23;43.67;27.94;16.84;3.35;1.71
2023-03-20;195.81;149.76;121.91;86.52;65.17;43.87;27.39;15.47;3.91;2.52
2023-03-20;195.81;149.76;121.91;86.52;65.17;43.87;27.39;15.47;3.91;2.52
2023-05-17;194.31;147.04;119.74;86.88;66.27;40.70;28.25;11.25;4.41;1.57
2023-05-23;194.51;147.17;119.94;87.08;66.42;40.90;28.43;11.45;4.57;1.74
2023-05-30;194.75;147.47;120.17;87.31;66.68;41.13;28.68;11.69;4.72;1.98
2023-07-19;196.00;148.91;121.84;88.27;66.51;42.77;29.65;11.41;5.55;3.45
2023-07-26;196.23;149.14;122.07;88.50;66.74;43.01;29.89;11.61;5.78;3.68
2023-09-13;197.40;150.72;122.65;83.12;62.20;41.71;29.12;11.32;6.12;4.94
2023-10-11;198.17;151.65;122.94;83.70;62.02;41.95;29.62;11.65;6.49;5.02
2023-12-06;199.73;149.88;121.27;82.11;62.99;42.80;28.14;12.61;8.12;4.14
2024-01-31;199.91;150.64;112.86;78.04;57.38;37.95;23.00;13.09;6.12;2.18
2024-03-27;200.18;152.31;113.17;78.05;55.92;38.80;18.89;12.15;4.71;2.14
2024-03-27;200.18;152.31;113.17;78.05;55.92;38.80;18.89;12.15;4.71;2.14
2024-05-22;201.32;153.77;113.37;79.47;53.13;37.62;18.58;13.72;4.47;2.58
2024-07-24;198.62;154.40;108.55;80.87;52.91;34.24;19.04;11.95;4.88;2.57
2024-07-31;198.38;154.63;108.19;81.11;53.07;34.48;19.28;12.18;5.11;2.72
2024-09-11;197.12;153.10;104.69;77.92;51.31;30.49;19.55;10.31;4.88;2.37
2024-09-18;197.12;153.33;104.92;78.15;51.52;30.70;19.78;10.52;5.03;2.47
CACHE
    ;

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81001) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}
