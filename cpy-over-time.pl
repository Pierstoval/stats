#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub cpyuse {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /[ch]\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $cmd;
    for(@files) {
        $cmd .= "$tag:$_ ";
    }

    my $count;
    my $alloc;

    open(G, "git show $cmd 2>/dev/null| grep -E '(mem|str|strn)cpy\\('|");
    while(<G>) {
        $count++;
    }
    close(G);

    open(G, "git show $cmd 2>/dev/null| grep -E '(re|m|c)alloc\\('|");
    while(<G>) {
        $alloc++;
    }
    close(G);

    my $blanks, $comments, $code;
    open(G, "git show $cmd 2>/dev/null| cloc --force-lang=C --csv -|");
    while(<G>) {
        if($_ =~ /^1,SUM,(\d*),(\d*),(\d*)/) {
            ($blanks, $comments, $code)=($1, $2, $3);
            last;
        }
    }
    close(G);

    return ($count, $alloc, $code);
}

print <<CACHE
2000-03-14;200;43;391;22
2000-03-21;199;43;389;22
2000-03-21;199;43;389;22
2000-08-21;195;48;360;26
2000-08-30;196;48;362;26
2000-09-28;196;55;318;34
2000-10-16;196;56;234;47
2000-12-04;206;54;236;47
2001-01-05;207;54;238;47
2001-01-27;208;54;238;47
2001-02-13;215;54;247;47
2001-03-22;229;54;233;53
2001-04-04;221;56;233;53
2001-04-23;222;56;235;53
2001-05-07;224;56;237;53
2001-06-07;227;56;240;53
2001-08-20;235;53;223;56
2001-09-25;230;58;205;65
2001-11-04;226;61;212;65
2001-12-05;226;63;209;68
2002-01-23;240;64;199;77
2002-02-05;237;65;197;78
2002-03-07;238;66;199;79
2002-04-15;244;65;203;78
2002-05-13;244;66;192;84
2002-06-13;247;66;194;84
2002-10-01;255;67;203;84
2002-10-11;256;67;202;85
2002-11-18;250;69;203;85
2003-01-14;245;71;202;86
2003-04-02;235;68;186;86
2003-05-19;227;72;182;90
2003-07-28;216;82;188;94
2003-08-15;223;82;190;96
2003-11-01;220;85;189;99
2004-01-22;228;84;193;99
2004-03-18;244;83;180;112
2004-04-26;251;82;178;116
2004-06-02;265;84;184;121
2004-08-10;295;76;191;117
2004-10-18;294;78;196;117
2004-12-20;305;78;201;118
2005-02-01;311;77;201;119
2005-03-04;308;81;208;120
2005-04-05;305;82;205;122
2005-05-16;313;82;209;123
2005-09-01;314;83;208;125
2005-10-13;317;84;211;126
2005-12-06;320;84;210;128
2006-02-27;327;83;212;128
2006-03-20;327;83;212;128
2006-06-12;317;91;218;132
2006-08-07;318;92;220;133
2006-10-29;321;94;225;134
2007-01-29;309;102;222;142
2007-04-11;321;103;228;145
2007-06-25;315;108;230;148
2007-07-10;311;111;231;149
2007-09-13;334;106;239;148
2007-10-29;332;109;232;156
2008-01-28;322;114;231;159
2008-03-30;323;114;232;159
2008-06-04;327;114;233;160
2008-09-01;327;116;234;162
2008-11-05;307;126;230;168
2008-11-13;307;126;231;167
2009-01-19;312;124;243;159
2009-03-02;263;153;230;175
2009-05-18;264;153;233;173
2009-08-12;256;159;234;174
2009-11-04;261;158;237;174
2010-02-09;286;156;244;183
2010-04-14;290;156;247;183
2010-06-16;298;163;251;193
2010-08-11;295;166;255;192
2010-10-12;293;168;254;194
2010-12-15;296;168;256;194
2011-02-17;300;169;251;202
2011-04-17;304;169;254;202
2011-04-22;305;169;255;202
2011-06-23;306;168;257;200
2011-09-13;312;167;259;201
2011-11-14;312;168;260;202
2011-11-17;312;168;260;202
2012-01-24;317;168;263;202
2012-03-22;316;169;264;202
2012-05-24;315;171;264;204
2012-07-27;318;179;266;214
2012-10-10;322;179;268;215
2012-11-20;323;179;269;215
2013-02-06;328;177;267;217
2013-04-12;322;184;268;221
2013-06-22;321;187;268;224
2013-08-11;325;191;270;230
2013-10-13;346;181;271;231
2013-12-16;347;182;273;231
2014-01-29;349;182;274;232
2014-03-26;322;201;273;237
2014-05-20;322;203;275;237
2014-07-16;322;204;273;241
2014-09-10;322;208;271;247
2014-11-05;324;206;266;251
2015-01-07;316;218;266;259
2015-02-25;309;220;262;259
2015-04-22;309;220;262;259
2015-04-28;309;220;262;259
2015-06-17;311;220;266;257
2015-08-11;307;224;263;262
2015-10-07;308;224;265;260
2015-12-01;309;226;267;261
2016-01-27;308;227;266;263
2016-02-08;308;227;266;263
2016-03-23;309;227;267;263
2016-05-17;313;228;270;265
2016-05-30;314;228;269;266
2016-07-21;316;227;271;265
2016-08-03;316;227;271;265
2016-09-07;318;227;272;265
2016-09-14;318;227;272;265
2016-11-02;320;225;272;265
2016-12-20;323;227;270;271
2016-12-22;323;227;270;271
2017-02-22;323;228;268;275
2017-02-24;323;228;268;275
2017-04-19;326;227;272;272
2017-06-14;322;231;272;273
2017-08-09;320;232;272;273
2017-08-13;321;232;272;273
2017-10-04;312;244;273;279
2017-10-23;314;244;274;279
2017-11-29;316;245;276;280
2018-01-23;323;247;280;285
2018-03-13;322;249;281;285
2018-05-15;323;251;279;290
2018-07-11;323;252;281;290
2018-09-04;324;252;279;292
2018-10-30;327;257;284;296
2018-12-12;327;256;283;296
2019-02-06;324;259;284;296
2019-03-27;325;261;284;298
2019-05-22;330;256;285;296
2019-06-04;330;256;285;296
2019-07-17;330;256;285;296
2019-07-19;330;256;285;296
2019-09-10;330;264;288;303
2019-11-05;327;267;286;305
2020-01-08;318;278;286;309
2020-03-04;320;279;289;309
2020-03-11;321;279;290;309
2020-04-29;315;288;288;315
2020-06-23;326;281;317;289
2020-06-30;325;282;316;290
2020-08-19;326;282;316;291
2020-10-14;327;282;317;291
2020-12-09;328;282;315;294
2021-02-03;338;280;316;300
2021-03-31;346;276;317;301
2021-04-14;346;276;318;300
2021-05-26;344;279;318;302
2021-07-21;337;286;316;305
2021-09-14;343;282;317;305
2021-09-22;342;283;317;305
2021-11-10;341;285;318;306
2022-01-05;337;290;319;307
2022-03-05;340;284;318;303
2022-04-27;338;289;319;306
2022-05-11;337;290;319;306
2022-06-27;337;292;318;310
2022-08-31;337;294;319;311
2022-10-26;338;296;335;299
2022-12-21;343;296;332;306
2023-02-15;361;292;331;318
2023-02-20;361;292;331;318
2023-03-20;371;285;339;312
2023-03-20;371;285;339;312
2023-05-17;390;281;345;318
2023-05-23;390;281;345;318
2023-05-30;390;281;345;318
2023-07-19;392;281;346;318
2023-07-26;392;281;346;318
2023-09-13;388;279;342;316
2023-10-11;386;280;340;317
2023-12-06;385;282;342;318
2024-01-31;450;247;382;291
2024-03-27;477;237;393;288
2024-03-27;477;237;393;288
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($cpy, $alloc, $code) = cpyuse($t, "lib");
    printf "$d;%u;%u;%u;%u\n", $code / $cpy, $cpy, $code / $alloc, $alloc;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 80701) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
