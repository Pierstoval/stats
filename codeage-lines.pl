#!/usr/bin/perl

require "./stats/tag2date.pm";

my %authors;

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}

sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

# start is the epoch date to check for
# @a is the array of epoch commit dates
#
# Returns number of lines from after the cut-off date
sub fromafter {
    my ($after, @a) = (@_);
    my @vals = sort {$b <=> $a} @a;
    my $count;
    for my $i (@vals) {
        if($i > $after) {
            $count++;
        }
    }

    return $count;
}

sub singlefile {
    my ($tag, $f) = @_;
    open(G, "git blame -t --line-porcelain $f $tag|");
    my $author;
    my @stamp;
    while(<G>) {
        if(/^committer-time (.*)/) {
            # store every timestamp
            push @stamp, $1;
        }
    }
    close(G);
    return @stamp;
}

my %cutoff;

# store the cutoff years in epoch seconds
for my $year (2000 .. 2030) {
    $cutoff{$year} = `date +%s -d "$year-01-01"`;
}

sub show {
    my ($tag, $date) = @_;
    my @stamp;
    my @f=`git ls-tree -r --name-only $tag -- src lib include 2>/dev/null`;

    for my $e (@f) {
        chomp $e;
        if(($e =~ /\.[ch]\z/) || ($e =~ /makefile/i)) {
            push @stamp, singlefile($tag, $e);
        }
    }

    printf "$date";

    for (my $i = 2000; $i <= 2026; $i += 2) {
        printf ";%u", fromafter($cutoff{$i}, @stamp);
    }
    print "\n";
}

print <<CACHE
2000-03-14;1911;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-03-21;2407;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-03-21;2742;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-08-21;6679;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-08-30;6883;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-09-28;8993;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-10-16;9909;0;0;0;0;0;0;0;0;0;0;0;0;0
2000-12-04;10957;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-01-05;11748;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-01-27;11413;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-02-13;11904;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-03-22;14143;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-04-04;14267;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-04-23;14426;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-05-07;14623;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-06-07;15101;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-08-20;15441;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-09-25;17260;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-11-04;18710;0;0;0;0;0;0;0;0;0;0;0;0;0
2001-12-05;19477;0;0;0;0;0;0;0;0;0;0;0;0;0
2002-01-23;21177;2372;0;0;0;0;0;0;0;0;0;0;0;0
2002-02-05;21430;2658;0;0;0;0;0;0;0;0;0;0;0;0
2002-03-07;22155;2961;0;0;0;0;0;0;0;0;0;0;0;0
2002-04-15;23604;4980;0;0;0;0;0;0;0;0;0;0;0;0
2002-05-13;24186;5687;0;0;0;0;0;0;0;0;0;0;0;0
2002-06-13;24768;6505;0;0;0;0;0;0;0;0;0;0;0;0
2002-10-01;26418;9013;0;0;0;0;0;0;0;0;0;0;0;0
2002-10-11;26510;9277;0;0;0;0;0;0;0;0;0;0;0;0
2002-11-18;26702;9682;0;0;0;0;0;0;0;0;0;0;0;0
2003-01-14;27200;10556;0;0;0;0;0;0;0;0;0;0;0;0
2003-04-02;27118;11403;0;0;0;0;0;0;0;0;0;0;0;0
2003-05-19;27764;12138;0;0;0;0;0;0;0;0;0;0;0;0
2003-07-28;30704;15297;0;0;0;0;0;0;0;0;0;0;0;0
2003-08-15;31714;16504;0;0;0;0;0;0;0;0;0;0;0;0
2003-11-01;33140;18691;0;0;0;0;0;0;0;0;0;0;0;0
2004-01-22;34410;20581;1013;0;0;0;0;0;0;0;0;0;0;0
2004-03-18;37524;24158;5330;0;0;0;0;0;0;0;0;0;0;0
2004-04-26;38562;25423;7185;0;0;0;0;0;0;0;0;0;0;0
2004-06-02;41697;29198;12312;0;0;0;0;0;0;0;0;0;0;0
2004-08-10;42209;30571;14614;0;0;0;0;0;0;0;0;0;0;0
2004-10-18;43316;31902;16299;0;0;0;0;0;0;0;0;0;0;0
2004-12-20;45126;33915;18785;0;0;0;0;0;0;0;0;0;0;0
2005-02-01;46140;35008;20217;0;0;0;0;0;0;0;0;0;0;0
2005-03-04;47740;37270;22972;0;0;0;0;0;0;0;0;0;0;0
2005-04-05;47682;37645;23412;0;0;0;0;0;0;0;0;0;0;0
2005-05-16;49040;39266;25391;0;0;0;0;0;0;0;0;0;0;0
2005-09-01;49731;40079;26320;0;0;0;0;0;0;0;0;0;0;0
2005-10-13;50650;41002;27247;0;0;0;0;0;0;0;0;0;0;0
2005-12-06;51107;41489;27772;0;0;0;0;0;0;0;0;0;0;0
2006-02-27;51792;42277;28644;772;0;0;0;0;0;0;0;0;0;0
2006-03-20;51828;42313;28680;836;0;0;0;0;0;0;0;0;0;0
2006-06-12;55185;45750;32421;5363;0;0;0;0;0;0;0;0;0;0
2006-08-07;56028;46623;33391;6701;0;0;0;0;0;0;0;0;0;0
2006-10-29;57568;48446;35772;10806;0;0;0;0;0;0;0;0;0;0
2007-01-29;59924;50883;38364;13656;0;0;0;0;0;0;0;0;0;0
2007-04-11;62164;53367;41063;17136;0;0;0;0;0;0;0;0;0;0
2007-06-25;63475;54710;42430;18656;0;0;0;0;0;0;0;0;0;0
2007-07-10;64223;55486;43252;19600;0;0;0;0;0;0;0;0;0;0
2007-09-13;66131;57703;45708;22786;0;0;0;0;0;0;0;0;0;0
2007-10-29;67530;59208;47312;24638;0;0;0;0;0;0;0;0;0;0
2008-01-28;68682;60623;49094;27226;1452;0;0;0;0;0;0;0;0;0
2008-03-30;69535;61525;50131;28577;3267;0;0;0;0;0;0;0;0;0
2008-06-04;70886;62928;52270;31041;6315;0;0;0;0;0;0;0;0;0
2008-09-01;72554;64803;54630;34410;10704;0;0;0;0;0;0;0;0;0
2008-11-05;73997;66352;56352;36660;13495;0;0;0;0;0;0;0;0;0
2008-11-13;73945;66317;56364;36764;13708;0;0;0;0;0;0;0;0;0
2009-01-19;74294;66750;56880;37439;14687;0;0;0;0;0;0;0;0;0
2009-03-02;76606;69083;59241;39923;17451;0;0;0;0;0;0;0;0;0
2009-05-18;77003;69512;59722;40543;18466;0;0;0;0;0;0;0;0;0
2009-08-12;78897;71446;61710;42777;20979;0;0;0;0;0;0;0;0;0
2009-11-04;79795;72349;62662;43811;22150;0;0;0;0;0;0;0;0;0
2010-02-09;85667;78348;68825;50968;31223;4526;0;0;0;0;0;0;0;0
2010-04-14;86388;79177;69792;52115;32582;6329;0;0;0;0;0;0;0;0
2010-06-16;91097;83943;74581;57025;37744;11833;0;0;0;0;0;0;0;0
2010-08-11;91580;84431;75088;57664;38460;13149;0;0;0;0;0;0;0;0
2010-10-12;92382;85476;76293;59058;40223;15229;0;0;0;0;0;0;0;0
2010-12-15;93179;86316;77339;60020;41147;16293;0;0;0;0;0;0;0;0
2011-02-17;94833;87989;79039;61914;43171;18509;0;0;0;0;0;0;0;0
2011-04-17;96177;89375;80466;63402;45105;20671;0;0;0;0;0;0;0;0
2011-04-22;96487;89696;80800;63756;45833;21470;0;0;0;0;0;0;0;0
2011-06-23;96837;90402;81782;65058;47592;23796;0;0;0;0;0;0;0;0
2011-09-13;97882;91573;83673;67518;50804;27779;0;0;0;0;0;0;0;0
2011-11-14;101838;96345;89507;74460;58744;36878;0;0;0;0;0;0;0;0
2011-11-17;101836;96343;89505;74458;58742;36876;0;0;0;0;0;0;0;0
2012-01-24;102965;97507;90701;75800;60199;38493;324;0;0;0;0;0;0;0
2012-03-22;103662;98215;91410;76529;60963;39384;1649;0;0;0;0;0;0;0
2012-05-24;103406;97982;91615;76950;61617;40379;3409;0;0;0;0;0;0;0
2012-07-27;109022;103648;97299;82676;67428;46626;10396;0;0;0;0;0;0;0
2012-10-10;109969;104601;98259;83686;68565;47815;11680;0;0;0;0;0;0;0
2012-11-20;110522;105158;98827;84296;69210;48501;12421;0;0;0;0;0;0;0
2013-02-06;110861;105817;99694;85929;71616;51909;17163;0;0;0;0;0;0;0
2013-04-12;112789;107798;101793;88140;73916;54892;20573;0;0;0;0;0;0;0
2013-06-22;114070;109082;103085;89474;75288;56442;22388;0;0;0;0;0;0;0
2013-08-11;117304;112333;106349;92856;78786;60187;26348;0;0;0;0;0;0;0
2013-10-13;118179;113468;107641;94357;80605;62237;28770;0;0;0;0;0;0;0
2013-12-16;119078;114406;108625;95447;81797;63518;30305;0;0;0;0;0;0;0
2014-01-29;119545;114941;109170;96009;82384;64236;31163;434;0;0;0;0;0;0
2014-03-26;121342;116741;110976;97826;84222;66133;33772;3426;0;0;0;0;0;0
2014-05-20;122312;117722;111961;98851;85268;67242;35054;5002;0;0;0;0;0;0
2014-07-16;122954;118369;112627;99537;85979;67988;35853;5883;0;0;0;0;0;0
2014-09-10;124793;120215;114538;101484;87964;70098;38285;8538;0;0;0;0;0;0
2014-11-05;124645;120102;114455;101477;88580;70969;39541;10306;0;0;0;0;0;0
2015-01-07;128112;123601;118063;105400;92683;75331;44471;16007;0;0;0;0;0;0
2015-02-25;126918;122415;117146;104533;91887;74591;44248;17714;0;0;0;0;0;0
2015-04-22;127074;122630;117413;104953;92445;75374;45410;19183;0;0;0;0;0;0
2015-04-28;127079;122635;117418;104959;92451;75389;45429;19210;0;0;0;0;0;0
2015-06-17;127942;123549;118371;105989;93573;76584;46741;21041;0;0;0;0;0;0
2015-08-11;128464;124074;118896;106518;94115;77129;47324;21657;0;0;0;0;0;0
2015-10-07;128849;124491;119327;106964;94576;77686;48003;22389;0;0;0;0;0;0
2015-12-01;130208;125878;120734;108426;96070;79280;49701;24232;0;0;0;0;0;0
2016-01-27;130624;126294;121150;108853;96523;79755;50246;24804;478;0;0;0;0;0
2016-02-08;130907;126577;121525;109265;96956;80229;50890;25508;1224;0;0;0;0;0
2016-03-23;131220;126898;121861;109639;97377;80754;51498;26217;2276;0;0;0;0;0
2016-05-17;133334;129054;124078;111958;99840;83374;54480;29804;8518;0;0;0;0;0
2016-05-30;133520;129240;124264;112144;100026;83560;54666;30000;8722;0;0;0;0;0
2016-07-21;133899;129688;124748;112734;100719;84366;55684;31271;10306;0;0;0;0;0
2016-08-03;133923;129712;124772;112758;100743;84390;55708;31295;10330;0;0;0;0;0
2016-09-07;134446;130236;125297;113289;101349;85030;56506;32140;11332;0;0;0;0;0
2016-09-14;134482;130273;125334;113331;101391;85072;56552;32196;11395;0;0;0;0;0
2016-11-02;134436;130263;125331;113501;101658;85593;57198;33065;12394;0;0;0;0;0
2016-12-20;136374;132252;127361;115679;104029;88179;60330;36925;16659;0;0;0;0;0
2016-12-22;136374;132252;127361;115679;104029;88179;60330;36925;16660;0;0;0;0;0
2017-02-22;135598;131583;126720;115417;103811;88045;60620;37456;17368;0;0;0;0;0
2017-02-24;135624;131609;126746;115443;103838;88072;60647;37484;17397;0;0;0;0;0
2017-04-19;136565;132578;127761;116520;105048;89457;62452;39467;19614;0;0;0;0;0
2017-06-14;136987;133002;128335;117149;105730;90281;63795;40909;21453;0;0;0;0;0
2017-08-09;136939;132983;128324;117165;105869;90940;64661;41906;22512;0;0;0;0;0
2017-08-13;137070;133114;128455;117296;106002;91075;64796;42043;22653;0;0;0;0;0
2017-10-04;139845;135970;131387;120634;109555;95025;69550;47789;29128;0;0;0;0;0
2017-10-23;140340;136469;131890;121157;110101;95576;70117;48383;29737;0;0;0;0;0
2017-11-29;141528;137996;133615;123265;112567;98472;73489;52109;33716;0;0;0;0;0
2018-01-23;144857;141333;136962;126625;116085;102042;77160;55908;37599;384;0;0;0;0
2018-03-13;145687;142203;137849;127558;117056;103096;78463;57252;39112;2231;0;0;0;0
2018-05-15;146892;143414;139061;128791;118320;104387;79873;58800;40796;4362;0;0;0;0
2018-07-11;147182;143737;139391;129291;118869;104991;80656;59712;41832;5630;0;0;0;0
2018-09-04;147464;144027;139690;129606;119239;105385;81124;60287;42581;6564;0;0;0;0
2018-10-30;150541;147132;142858;132935;122725;109202;85338;64977;47509;11969;0;0;0;0
2018-12-12;150182;146783;142520;132638;122444;108948;85646;65572;48226;13067;0;0;0;0
2019-02-06;150766;147367;143107;133229;123055;109595;86358;66364;49093;14151;0;0;0;0
2019-03-27;151831;148498;144280;134543;124497;111125;88110;68383;51255;17220;0;0;0;0
2019-05-22;151346;148020;143821;134121;124244;110953;88093;68868;52270;18875;0;0;0;0
2019-06-04;151490;148164;143970;134270;124397;111121;88270;69057;52485;19134;0;0;0;0
2019-07-17;151507;148188;144001;134317;124462;111208;88418;69248;52779;19543;0;0;0;0
2019-07-19;151497;148178;143991;134308;124495;111266;88483;69318;52849;19613;0;0;0;0
2019-09-10;155634;152332;148178;138586;128840;115843;93656;74698;58521;25650;0;0;0;0
2019-11-05;156023;152726;148581;139022;129376;116411;94337;75446;59348;26721;0;0;0;0
2020-01-08;157635;154338;150194;140659;131031;118081;96146;77586;61563;29064;40;0;0;0
2020-03-04;158992;155769;151699;142334;133060;120325;98749;80565;64986;33246;4887;0;0;0
2020-03-11;159262;156039;151972;142617;133350;120623;99065;80898;65322;33622;5312;0;0;0
2020-04-29;160926;157741;153685;144373;135161;122458;100995;82918;67518;36333;8383;0;0;0
2020-06-23;162394;159292;155274;146066;136978;124507;103410;85627;70481;40084;13217;0;0;0
2020-06-30;162426;159325;155307;146102;137014;124546;103454;85697;70556;40179;13343;0;0;0
2020-08-19;162899;159799;155787;146583;137500;125053;103970;86225;71119;40986;14201;0;0;0
2020-10-14;162478;159551;155591;146670;137772;126198;105902;88287;73695;44239;17788;0;0;0
2020-12-09;163213;160297;156341;147424;138571;127041;106867;89346;74830;45847;19705;0;0;0
2021-02-03;165823;163001;159099;150371;141737;130858;111282;94416;80384;52781;28040;0;0;0
2021-03-31;166669;163907;160028;151364;142817;132064;112676;95992;82086;54704;30268;0;0;0
2021-04-14;166696;163934;160062;151405;142887;132148;112766;96082;82188;54817;30395;0;0;0
2021-05-26;167563;164822;160969;152328;144013;133381;114113;98095;84532;57793;33842;0;0;0
2021-07-21;166642;163902;160089;151511;143283;132732;113631;98655;85336;58882;35470;0;0;0
2021-09-14;167062;164323;160512;151941;143765;133231;114158;99267;85996;59670;36394;0;0;0
2021-09-22;167080;164341;160530;151960;143784;133250;114185;99294;86023;59698;36423;0;0;0
2021-11-10;167961;165225;161420;152859;144691;134199;115161;100314;87127;61085;37985;0;0;0
2022-01-05;168771;166040;162284;153738;145621;135148;116402;101624;88547;62764;39947;74;0;0
2022-03-05;164075;161347;157603;149613;142515;133270;115394;100911;88156;63021;41791;2835;0;0
2022-04-27;165877;163152;159410;151432;144340;135104;117267;102811;90098;65029;44018;5376;0;0
2022-05-11;166017;163292;159550;151572;144480;135246;117414;102982;90269;65235;44237;5650;0;0
2022-06-27;167917;165215;161481;153505;146434;137216;119409;104985;92298;67392;46570;8541;0;0
2022-08-31;168633;165941;162323;154409;147455;138475;120763;106390;93756;68976;48344;10603;0;0
2022-10-26;169748;167058;163486;155611;148796;139974;122678;108685;96330;71994;52169;15348;0;0
2022-12-21;171808;169185;165728;158031;151407;142806;125987;112329;100279;77024;57706;23483;0;0
2023-02-15;176505;173928;170504;162913;156406;147983;131447;118041;106492;83984;65747;33061;0;0
2023-02-20;176568;173991;170567;162977;156471;148048;131522;118117;106591;84101;65896;33223;0;0
2023-03-20;177101;174543;171139;163605;157165;148761;132449;119101;107708;85458;67459;34983;0;0
2023-03-20;177085;174527;171123;163589;157149;148745;132433;119085;107692;85442;67443;34967;0;0
2023-05-17;182276;179734;176341;168867;162443;154100;137909;124657;113536;91540;74066;42146;0;0
2023-05-23;182290;179755;176362;168896;162476;154133;137948;124700;113582;91605;74154;42264;0;0
2023-05-30;182177;179642;176249;168784;162364;154021;137854;124622;113504;91540;74096;42233;0;0
2023-07-19;182999;180465;177072;169611;163193;154852;138731;125533;114655;92767;75476;43941;0;0
2023-07-26;183008;180474;177081;169620;163203;154862;138743;125545;114667;92780;75489;43962;0;0
2023-09-13;181001;178479;175102;167674;161582;153432;137839;125829;115707;94551;77561;46560;0;0
2023-10-11;181021;178508;175153;167755;161714;153630;138129;126308;116305;95319;78396;47610;0;0
2023-12-06;182065;179569;176241;168900;162984;155089;139855;128163;118248;97653;80964;50946;0;0
2024-01-31;184938;182466;179192;172064;166238;158672;144119;132886;123134;103225;86995;57597;7200;0
2024-03-27;187701;185271;182092;175114;169431;162184;147791;136671;127159;107504;91704;63587;14578;0
2024-03-27;187701;185271;182092;175114;169431;162184;147791;136671;127159;107504;91704;63587;14578;0
2024-05-22;190320;187900;184743;177807;172175;165016;151063;140100;130721;111325;95840;68323;20679;0
2024-07-24;193393;191005;187915;181118;175708;168665;154967;144215;135036;116011;101090;74974;28768;0
2024-07-31;193510;191122;188032;181245;175836;168793;155095;144359;135185;116166;101248;75150;28974;0
2024-09-11;195345;192979;189939;183210;177904;170980;157425;146891;138002;119719;105381;80119;35906;0
2024-09-18;195425;193059;190019;183290;177984;171063;157511;146977;138093;119813;105480;80225;36047;0
CACHE
    ;

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 81001) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}
